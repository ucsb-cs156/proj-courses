import { render, screen, waitFor, fireEvent } from "@testing-library/react";
import { QueryClient, QueryClientProvider } from "react-query";
import { MemoryRouter } from "react-router-dom";
import axios from "axios";
import AxiosMockAdapter from "axios-mock-adapter";
import mockConsole from "tests/testutils/mockConsole";
import { vi } from "vitest";
import * as useBackendModule from "main/utils/useBackend";


import { apiCurrentUserFixtures } from "fixtures/currentUserFixtures";
import { systemInfoFixtures } from "fixtures/systemInfoFixtures";
import usersFixturesPaged from "fixtures/usersFixturesPaged";
import AdminUsersPage from "main/pages/Admin/AdminUsersPage";

describe("AdminUsersPage tests", () => {
  const axiosMock = new AxiosMockAdapter(axios);

  const testId = "UsersTable";

  beforeEach(() => {
    vi.spyOn(useBackendModule, "useBackend");
    axiosMock.reset();
    axiosMock.resetHistory();
    axiosMock
      .onGet("/api/currentUser")
      .reply(200, apiCurrentUserFixtures.userOnly);
    axiosMock
      .onGet("/api/systemInfo")
      .reply(200, systemInfoFixtures.showingNeither);
  });

  test("renders without crashing on three users", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.threeUsersPaged);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    expect(await screen.findByText("Users")).toBeInTheDocument();
    expect(
      await screen.findByTestId("UsersTable-cell-row-0-col-id"),
    ).toBeInTheDocument();

    expect(
      screen.getByTestId(`UsersTable-cell-row-0-col-id`),
    ).toHaveTextContent("1");
    expect(
      screen.getByTestId(`UsersTable-cell-row-0-col-givenName`),
    ).toHaveTextContent("Phill");
    expect(
      screen.getByTestId(`UsersTable-cell-row-0-col-familyName`),
    ).toHaveTextContent("Conrad");
    expect(
      screen.getByTestId(`UsersTable-cell-row-0-col-email`),
    ).toHaveTextContent("phtcon@ucsb.edu");
    expect(
      screen.getByTestId(`UsersTable-cell-row-0-col-admin`),
    ).toHaveTextContent("true");
  });

  test("renders empty table when backend unavailable", async () => {
    const queryClient = new QueryClient();
    axiosMock.onGet("/api/admin/users/paged?page=0&size=5").timeout();

    const restoreConsole = mockConsole();

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    await waitFor(() => {
      expect(axiosMock.history.get.length).toBeGreaterThanOrEqual(1);
    });

    const errorMessage = console.error.mock.calls[0][0];
    expect(errorMessage).toMatch(
      "Error communicating with backend via GET on /api/admin/users/paged",
    );
    restoreConsole();

    expect(
      screen.queryByTestId(`${testId}-cell-row-0-col-id`),
    ).not.toBeInTheDocument();
  });

  test("clicking Next loads page 1", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    axiosMock
      .onGet("/api/admin/users/paged?page=1&size=5")
      .reply(200, usersFixturesPaged.page1);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    expect(await screen.findByText("Users")).toBeInTheDocument();

    const nextButton = await screen.findByText("Next");
    fireEvent.click(nextButton);

    await waitFor(() => {
      const urls = axiosMock.history.get.map((r) => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=1&size=5");
    });

    expect(
      await screen.findByTestId("UsersTable-cell-row-0-col-id"),
    ).toHaveTextContent(String(usersFixturesPaged.page1.content[0].id));
  });

  test("clicking Previous loads page 0", async () => {
    const queryClient = new QueryClient();

    // First page load (page 0)
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    // After clicking next (page 1)
    axiosMock
      .onGet("/api/admin/users/paged?page=1&size=5")
      .reply(200, usersFixturesPaged.page1);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    // Page 0 should load first
    await waitFor(() => {
      const urls = axiosMock.history.get.map((r) => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=0&size=5");
    });

    // Click NEXT → move to page 1
    const nextButton = await screen.findByText("Next");
    fireEvent.click(nextButton);

    await waitFor(() => {
      const urls = axiosMock.history.get.map((r) => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=1&size=5");
    });

    // Click PREVIOUS → should return to page 0
    const prevButton = await screen.findByText("Previous");
    fireEvent.click(prevButton);

    await waitFor(() => {
      const urls = axiosMock.history.get.map((r) => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=0&size=5");
    });

    expect(
      await screen.findByTestId("UsersTable-cell-row-0-col-id"),
    ).toHaveTextContent(String(usersFixturesPaged.page0.content[0].id));
  });
  test("changing page size triggers reset to page 0", async () => {
    const queryClient = new QueryClient();

    // initial load page=0 size=5
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    // expect request with page=0 size=10 after change
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=10")
      .reply(200, usersFixturesPaged.page0_size10);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    // Wait for initial request to finish
    await screen.findByTestId("UsersTable-cell-row-0-col-id");

    // Select element
    const select = screen.getByLabelText("Page Size:");

    // Change page size to 10
    fireEvent.change(select, { target: { value: "10" } });

    // Ensure new request fires with page reset to 0
    await waitFor(() => {
      const urls = axiosMock.history.get.map((r) => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=0&size=10");
    });
  });
  test("Previous button is disabled on page 0", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    const prevButton = await screen.findByText("Previous");
    expect(prevButton).toBeDisabled();
  });

  test("Next button is disabled on last page", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=1&size=5")
      .reply(200, usersFixturesPaged.page1);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );

    const nextButton = await screen.findByText("Next");
    expect(nextButton).toBeDisabled();
  });

  test("page display updates when navigating", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    axiosMock
      .onGet("/api/admin/users/paged?page=1&size=5")
      .reply(200, usersFixturesPaged.page1);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>,
    );
    expect(await screen.findByText("Page 1 of 2")).toBeInTheDocument();

    const nextButton = await screen.findByText("Next");
    fireEvent.click(nextButton);

    expect(await screen.findByText("Page 2 of 2")).toBeInTheDocument();
  });

  test("makes correct backend request when page and size change", async () => {
    const queryClient = new QueryClient();

    // initial page=0 size=5
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    // after selecting size=20 → reset to page 0
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=20")
      .reply(200, usersFixturesPaged.page0);

    // page 1, size=20
// page 1, size=20
axiosMock
  .onGet("/api/admin/users/paged?page=1&size=20")
  .reply(200, usersFixturesPaged.page1_size20);


    // page 2, size=20
    axiosMock
      .onGet("/api/admin/users/paged?page=2&size=20")
      .reply(200, usersFixturesPaged.page0);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>
    );

    // allow initial page 0 load
    await screen.findByTestId("UsersTable-cell-row-0-col-id");

    // change page size
    const select = screen.getByLabelText("Page Size:");
    fireEvent.change(select, { target: { value: "20" } });

    // wait for page=0 size=20
    await waitFor(() => {
      const urls = axiosMock.history.get.map(r => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=0&size=20");
    });

    // click next → page 1
    fireEvent.click(screen.getByText("Next"));

    await waitFor(() => {
      const urls = axiosMock.history.get.map(r => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=1&size=20");
    });

    // click next → page 2
    fireEvent.click(screen.getByText("Next"));

    await waitFor(() => {
      const urls = axiosMock.history.get.map(r => r.url);
      expect(urls).toContain("/api/admin/users/paged?page=2&size=20");
    });
  });
  
  

  test("uses fallback values when pagedUsers is null", async () => {
    const queryClient = new QueryClient();
    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, null);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>
    );
    expect(screen.queryByTestId("UsersTable-cell-row-0-col-id")).not.toBeInTheDocument();
    expect(await screen.findByText("Page 1 of 1")).toBeInTheDocument();
  });  

  test("uses correct query key including page and size", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>
    );

    expect(useBackendModule.useBackend).toHaveBeenCalled();

    const call = useBackendModule.useBackend.mock.calls[0];

    expect(call[0]).toEqual(["/api/admin/users/paged", 0, 5]);
  });
  test("uses correct queryKey including page and size", async () => {
    const queryClient = new QueryClient();

    axiosMock
      .onGet("/api/admin/users/paged?page=0&size=5")
      .reply(200, usersFixturesPaged.page0);

    render(
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>
          <AdminUsersPage />
        </MemoryRouter>
      </QueryClientProvider>
    );

    expect(useBackendModule.useBackend).toHaveBeenCalled();

    const call = useBackendModule.useBackend.mock.calls[0];

    expect(call[0]).toEqual(["/api/admin/users/paged", 0, 5]);
  });
  

});
